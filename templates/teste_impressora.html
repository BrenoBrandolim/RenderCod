{% extends 'base.html' %}
{% block title %}Teste de Impressora{% endblock %}

{% block content %}
<h2>ğŸ§¾ Teste de Impressora TÃ©rmica</h2>
<p>Clique no botÃ£o abaixo para enviar uma impressÃ£o de teste para a impressora padrÃ£o (ELGIN i9 USB).</p>

<button onclick="imprimirTeste()" class="button primary">ğŸ–¨ï¸ Imprimir Teste</button>

<p id="status"></p>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/qz-tray/2.1.0/qz-tray.js"></script>
<script>
qz.security.setCertificatePromise(resolve => resolve(""));
qz.security.setSignaturePromise(() => Promise.resolve(""));

async function imprimirTeste() {
  const statusEl = document.getElementById('status');
  statusEl.textContent = "ğŸ”„ Conectando ao QZ Tray...";
  try {
    if (!qz.websocket.isActive()) {
      await qz.websocket.connect();
      statusEl.textContent = "âœ… QZ Tray conectado!";
    }

    const texto = `
---------------------------
   TESTE DE IMPRESSORA
---------------------------
Impressora: ELGIN i9 (USB)
Data: ${new Date().toLocaleString('pt-BR')}
---------------------------
Sucesso! ğŸ‰
`;

    const config = qz.configs.create(null); // impressora padrÃ£o
    const data = [{ type: 'raw', format: 'plain', data: texto }];
    await qz.print(config, data);
    statusEl.textContent = "âœ… ImpressÃ£o enviada com sucesso!";
  } catch (e) {
    console.error("Erro:", e);
    statusEl.textContent = "âŒ Erro ao imprimir. Verifique se o QZ Tray estÃ¡ aberto e permitido.";
  }
}
</script>
{% endblock %}
